@using System.Text.Json
@using Microsoft.JSInterop
@using Web.Models.Factory
@using Web.Models.Share
@using Web.Services
@inject IAppStateService AppState
@inject IConfigurationService Config
@inject IToastService Toast
@inject NavigationManager NavManager
@inject HttpClient Http
@inject IJSRuntime JSRuntime

<button 
    class="btn btn-primary btn-sm" 
    disabled="@_creating" 
    @onclick="CreateShareLink">
    <i class="fas fa-share-alt"></i>
</button>

@if (_showCopyDialog)
{
    <div class="modal-overlay" @onclick="() => _showCopyDialog = false">
        <div class="modal-dialog" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h3>Copy the link below</h3>
                <button class="close-btn" @onclick="() => _showCopyDialog = false">&times;</button>
            </div>
            <div class="modal-body">
                <p class="mb-4">Annoyingly your device / browser doesn't support copying to clipboard automatically. Please copy the link below manually.</p>
                <input type="text" class="form-control" value="@_link" readonly />
                <div class="text-center mt-4">
                    <button class="btn btn-success" @onclick="() => CopyLink(_link)">
                        <i class="fas fa-copy mr-2"></i>Copy
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private bool _creating = false;
    private string _link = string.Empty;
    private bool _showCopyDialog = false;

    private async Task CreateShareLink()
    {
        List<Factory> factories = AppState.GetFactories();
        
        if (factories == null || factories.Count == 0)
        {
            Toast.ShowToast("No factory data to share!", ToastType.Error);
            return;
        }

        _creating = true;
        StateHasChanged();

        try
        {
            // Create a FactoryTab from current factories
            FactoryTab currentTab = new FactoryTab
            {
                Id = Guid.NewGuid().ToString(),
                Name = "Shared Factories",
                Factories = factories
            };

            _link = await HandleCreation(currentTab) ?? string.Empty;
            _creating = false;
            StateHasChanged();

            // If no link was returned assume server errors
            if (string.IsNullOrEmpty(_link))
            {
                return;
            }

            Console.WriteLine($"ShareButton: Link created {_link}");

            try
            {
                await CopyLink(_link);
            }
            catch (Exception ex)
            {
                Console.Error.WriteLine($"Failed to copy link to clipboard: {ex.Message}");
                // Show the dialog as fallback
                _showCopyDialog = true;
                StateHasChanged();
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Error creating share link: {ex.Message}");
            Toast.ShowToast("Failed to create share link due to an error.", ToastType.Error);
            _creating = false;
            StateHasChanged();
        }
    }

    private async Task<string?> HandleCreation(FactoryTab factoryTabData)
    {
        string apiUrl = Config.GetApiUrl();

        try
        {
            string jsonContent = JsonSerializer.Serialize(factoryTabData);
            StringContent content = new StringContent(jsonContent, System.Text.Encoding.UTF8, "application/json");

            HttpResponseMessage response = await Http.PostAsync($"{apiUrl}/share", content);

            if (response.IsSuccessStatusCode)
            {
                string responseJson = await response.Content.ReadAsStringAsync();
                ShareDataCreationResponse? data = JsonSerializer.Deserialize<ShareDataCreationResponse>(responseJson);
                
                if (data != null)
                {
                    string baseUrl = NavManager.BaseUri.TrimEnd('/');
                    return $"{baseUrl}/share/{data.ShareId}";
                }
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.TooManyRequests)
            {
                Console.Error.WriteLine("Share Error: Rate limited");
                Toast.ShowToast("You are being rate limited. Stop spamming that button! Please wait some time before trying again.", ToastType.Error);
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.InternalServerError)
            {
                Console.Error.WriteLine($"Share Error: Server error - {response.StatusCode}");
                Toast.ShowToast("A server error has occurred trying to create the share link. Please report this on <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>!", ToastType.Error);
            }
            else if (response.StatusCode == System.Net.HttpStatusCode.BadGateway)
            {
                Console.Error.WriteLine($"Share Error: Gateway timeout - {response.StatusCode}");
                Toast.ShowToast("The backend server is offline! Please report this with urgency on <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>, ping @Maelstrome directly!", ToastType.Error);
            }
            else
            {
                Console.Error.WriteLine($"Share Error: Unknown response - {response.StatusCode}");
                Toast.ShowToast("Failed to create share link. Please report this error on our <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>!", ToastType.Error);
            }
        }
        catch (HttpRequestException ex)
        {
            Console.Error.WriteLine($"Share Error (HttpRequestException): {ex.Message}");
            if (ex.Message.Contains("Network"))
            {
                Toast.ShowToast("The backend server is offline! Please report this with urgency on <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>, ping @Maelstrome directly!", ToastType.Error);
            }
            else
            {
                Toast.ShowToast("Failed to create share link due to unknown error. Please report this error on our <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>!", ToastType.Error);
            }
        }
        catch (Exception ex)
        {
            Console.Error.WriteLine($"Share Error (catchall): {ex.Message}");
            Toast.ShowToast("Failed to create share link due to unknown error. Please report this error on our <a href=\"https://discord.gg/zge68PrGJ7\">Discord</a>!", ToastType.Error);
        }

        return null;
    }

    private async Task CopyLink(string url)
    {
        await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", url);
        Toast.ShowToast("Link copied to clipboard!", ToastType.Success);
        _showCopyDialog = false;
        StateHasChanged();
    }
}
